var Calendar=new Class({options:{blocked:[],classes:[],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],direction:0,draggable:true,months:["January","February","March","April","May","June","July","August","September","October","November","December"],navigation:1,offset:0,onHideStart:Class.empty,onHideComplete:Class.empty,onShowStart:Class.empty,onShowComplete:Class.empty,pad:1,tweak:{x:0,y:0}},initialize:function(e,i){if(!e){return false}this.setOptions(i);var g=["calendar","prev","next","month","year","today","invalid","valid","inactive","active","hover","hilite"];var a=g.map(function(j,k){if(this.options.classes[k]){if(this.options.classes[k].length){j=this.options.classes[k]}}return j},this);this.classes=a.associate(g);this.calendar=new Element("div",{styles:{left:"-1000px",opacity:0,position:"absolute",top:"-1000px",zIndex:1000}}).addClass(this.classes.calendar).injectInside(document.body);if(window.ie6){this.iframe=new Element("iframe",{styles:{left:"-1000px",position:"absolute",top:"-1000px",zIndex:999}}).injectInside(document.body);this.iframe.style.filter="progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)"}this.fx=this.calendar.effect("opacity",{onStart:function(){if(this.calendar.getStyle("opacity")==0){if(window.ie6){this.iframe.setStyle("display","block")}this.calendar.setStyle("display","block");this.fireEvent("onShowStart",this.element)}else{this.fireEvent("onHideStart",this.element)}}.bind(this),onComplete:function(){if(this.calendar.getStyle("opacity")==0){this.calendar.setStyle("display","none");if(window.ie6){this.iframe.setStyle("display","none")}this.fireEvent("onHideComplete",this.element)}else{this.fireEvent("onShowComplete",this.element)}}.bind(this)});if(window.Drag&&this.options.draggable){this.drag=new Drag.Move(this.calendar,{onDrag:function(){if(window.ie6){this.iframe.setStyles({left:this.calendar.style.left,top:this.calendar.style.top})}}.bind(this)})}this.calendars=[];var b=0;var c=new Date();c.setDate(c.getDate()+this.options.direction.toInt());for(var h in e){var f={button:new Element("button",{type:"button"}),el:$(h),els:[],id:b++,month:c.getMonth(),visible:false,year:c.getFullYear()};if(!this.element(h,e[h],f)){continue}f.el.addClass(this.classes.calendar);f.button.addClass(this.classes.calendar).addEvent("click",function(j){this.toggle(j)}.pass(f,this)).injectAfter(f.el);f.val=this.read(f);$extend(f,this.bounds(f));$extend(f,this.values(f));this.rebuild(f);this.calendars.push(f)}},blocked:function(c){var a=[];var b=new Date(c.year,c.month,1).getDay();var e=new Date(c.year,c.month+1,0).getDate();this.options.blocked.each(function(i){var k=i.split(" ");for(var h=0;h<=3;h++){if(!k[h]){k[h]=(h==3)?"":"*"}k[h]=k[h].contains(",")?k[h].split(","):new Array(k[h]);var g=k[h].length-1;for(var j=g;j>=0;j--){if(k[h][j].contains("-")){var f=k[h][j].split("-");for(var l=f[0];l<=f[1];l++){if(!k[h].contains(l)){k[h].push(l+"")}}k[h].splice(j,1)}}}if(k[2].contains(c.year+"")||k[2].contains("*")){if(k[1].contains(c.month+1+"")||k[1].contains("*")){k[0].each(function(n){if(n>0){a.push(n.toInt())}});if(k[3]){for(var h=0;h<e;h++){var m=(h+b)%7;if(k[3].contains(m+"")){a.push(h+1)}}}}}},this);return a},bounds:function(c){var b=new Date(1000,0,1);var a=new Date(2999,11,31);var e=new Date().getDate()+this.options.direction.toInt();if(this.options.direction>0){b=new Date();b.setDate(e+this.options.pad*c.id)}if(this.options.direction<0){a=new Date();a.setDate(e-this.options.pad*(this.calendars.length-c.id-1))}c.els.each(function(h){if(h.getTag()=="select"){if(h.format.test("(y|Y)")){var i=[];h.getChildren().each(function(j){var k=this.unformat(j.value,h.format);if(!i.contains(k[0])){i.push(k[0])}},this);i.sort(this.sort);if(i[0]>b.getFullYear()){d=new Date(i[0],b.getMonth()+1,0);if(b.getDate()>d.getDate()){b.setDate(d.getDate())}b.setYear(i[0])}if(i.getLast()<a.getFullYear()){d=new Date(i.getLast(),a.getMonth()+1,0);if(a.getDate()>d.getDate()){a.setDate(d.getDate())}a.setYear(i.getLast())}}if(h.format.test("(F|m|M|n)")){var g=[];var f=[];h.getChildren().each(function(j){var k=this.unformat(j.value,h.format);if($type(k[0])!="number"||k[0]==i[0]){if(!g.contains(k[1])){g.push(k[1])}}if($type(k[0])!="number"||k[0]==i.getLast()){if(!f.contains(k[1])){f.push(k[1])}}},this);g.sort(this.sort);f.sort(this.sort);if(g[0]>b.getMonth()){d=new Date(b.getFullYear(),g[0]+1,0);if(b.getDate()>d.getDate()){b.setDate(d.getDate())}b.setMonth(g[0])}if(f.getLast()<a.getMonth()){d=new Date(b.getFullYear(),f.getLast()+1,0);if(a.getDate()>d.getDate()){a.setDate(d.getDate())}a.setMonth(f.getLast())}}}},this);return{start:b,end:a}},caption:function(b){var a={prev:{month:true,year:true},next:{month:true,year:true}};if(b.year==b.start.getFullYear()){a.prev.year=false;if(b.month==b.start.getMonth()&&this.options.navigation==1){a.prev.month=false}}if(b.year==b.end.getFullYear()){a.next.year=false;if(b.month==b.end.getMonth()&&this.options.navigation==1){a.next.month=false}}if($type(b.months)=="array"){if(b.months.length==1&&this.options.navigation==2){a.prev.month=a.next.month=false}}var h=new Element("caption");var e=new Element("a").addClass(this.classes.prev).appendText("\x3c");var f=new Element("a").addClass(this.classes.next).appendText("\x3e");if(this.options.navigation==2){var c=new Element("span").addClass(this.classes.month).injectInside(h);if(a.prev.month){e.clone().addEvent("click",function(i){this.navigate(i,"m",-1)}.pass(b,this)).injectInside(c)}c.adopt(new Element("span").appendText(this.options.months[b.month]));if(a.next.month){f.clone().addEvent("click",function(i){this.navigate(i,"m",1)}.pass(b,this)).injectInside(c)}var g=new Element("span").addClass(this.classes.year).injectInside(h);if(a.prev.year){e.clone().addEvent("click",function(i){this.navigate(i,"y",-1)}.pass(b,this)).injectInside(g)}g.adopt(new Element("span").appendText(b.year));if(a.next.year){f.clone().addEvent("click",function(i){this.navigate(i,"y",1)}.pass(b,this)).injectInside(g)}}else{if(a.prev.month&&this.options.navigation){e.clone().addEvent("click",function(i){this.navigate(i,"m",-1)}.pass(b,this)).injectInside(h)}h.adopt(new Element("span").addClass(this.classes.month).appendText(this.options.months[b.month]));h.adopt(new Element("span").addClass(this.classes.year).appendText(b.year));if(a.next.month&&this.options.navigation){f.clone().addEvent("click",function(i){this.navigate(i,"m",1)}.pass(b,this)).injectInside(h)}}return h},changed:function(a){a.val=this.read(a);$extend(a,this.values(a));this.rebuild(a);if(!a.val){return}if(a.val.getDate()<a.days[0]){a.val.setDate(a.days[0])}if(a.val.getDate()>a.days.getLast()){a.val.setDate(a.days.getLast())}a.els.each(function(b){b.value=this.format(a.val,b.format)},this);this.check(a);this.calendars.each(function(b){if(b.visible){this.display(b)}},this)},check:function(a){this.calendars.each(function(c,f){if(c.val){var b=false;if(f<a.id){var e=new Date(Date.parse(a.val));e.setDate(e.getDate()-(this.options.pad*(a.id-f)));if(e<c.val){b=true}}if(f>a.id){var e=new Date(Date.parse(a.val));e.setDate(e.getDate()+(this.options.pad*(f-a.id)));if(e>c.val){b=true}}if(b){if(c.start>e){e=c.start}if(c.end<e){e=c.end}c.month=e.getMonth();c.year=e.getFullYear();$extend(c,this.values(c));c.val=c.days.contains(e.getDate())?e:null;this.write(c);if(c.visible){this.display(c)}}}else{c.month=a.month;c.year=a.year}},this)},clicked:function(b,a,c){c.val=(this.value(c)==a)?null:new Date(c.year,c.month,a);this.write(c);if(!c.val){c.val=this.read(c)}if(c.val){this.check(c);this.toggle(c)}else{b.addClass(this.classes.valid);b.removeClass(this.classes.active)}},display:function(m){this.calendar.empty();this.calendar.className=this.classes.calendar+" "+this.options.months[m.month].toLowerCase();var l=new Element("div").injectInside(this.calendar);var e=new Element("table").injectInside(l).adopt(this.caption(m));var f=new Element("thead").injectInside(e);var u=new Element("tr").injectInside(f);for(var g=0;g<=6;g++){var r=this.options.days[(g+this.options.offset)%7];u.adopt(new Element("th",{title:r}).appendText(r.substr(0,1)))}var v=new Element("tbody").injectInside(e);var u=new Element("tr").injectInside(v);var b=new Date(m.year,m.month,1);var s=((b.getDay()-this.options.offset)+7)%7;var n=new Date(m.year,m.month+1,0).getDate();var k=new Date(m.year,m.month,0).getDate();var q=this.value(m);var i=m.days;var j=[];var p=[];this.calendars.each(function(y,w){if(y!=m&&y.val){if(m.year==y.val.getFullYear()&&m.month==y.val.getMonth()){j.push(y.val.getDate())}if(m.val){for(var x=1;x<=n;x++){b.setDate(x);if((w<m.id&&b>y.val&&b<m.val)||(w>m.id&&b>m.val&&b<y.val)){if(!p.contains(x)){p.push(x)}}}}}},this);var b=new Date();var c=new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();for(var g=1;g<43;g++){if((g-1)%7==0){u=new Element("tr").injectInside(v)}var o=new Element("td").injectInside(u);var h=g-s;var a=new Date(m.year,m.month,h);var t="";if(h===q){t=this.classes.active}else{if(j.contains(h)){t=this.classes.inactive}else{if(i.contains(h)){t=this.classes.valid}else{if(h>=1&&h<=n){t=this.classes.invalid}}}}if(a.getTime()==c){t=t+" "+this.classes.today}if(p.contains(h)){t=t+" "+this.classes.hilite}o.addClass(t);if(i.contains(h)){o.setProperty("title",this.format(a,"D M jS Y"));o.addEvents({click:function(y,x,w){this.clicked(y,x,w)}.pass([o,h,m],this),mouseover:function(w,x){w.addClass(x)}.pass([o,this.classes.hover]),mouseout:function(w,x){w.removeClass(x)}.pass([o,this.classes.hover])})}if(h<1){h=k+h}else{if(h>n){h=h-n}}o.appendText(h)}},element:function(e,c,b){if($type(c)=="object"){for(var a in c){if(!this.element(a,c[a],b)){return false}}return true}e=$(e);if(!e){return false}e.format=c;if(e.getTag()=="select"){e.addEvent("change",function(f){this.changed(f)}.pass(b,this))}else{e.readOnly=true;e.addEvent("focus",function(f){this.toggle(f)}.pass(b,this))}b.els.push(e);return true},format:function(b,g){var i="";if(b){var m=b.getDate();var f=b.getDay();var a=this.options.days[f];var c=b.getMonth()+1;var j=this.options.months[c-1];var h=b.getFullYear()+"";for(var l=0,k=g.length;l<k;l++){var e=g.charAt(l);switch(e){case"y":h=h.substr(2);case"Y":i+=h;break;case"m":if(c<10){c="0"+c}case"n":i+=c;break;case"M":j=j.substr(0,3);case"F":i+=j;break;case"d":if(m<10){m="0"+m}case"j":i+=m;break;case"D":a=a.substr(0,3);case"l":i+=a;break;case"N":f+=1;case"w":i+=f;break;case"S":if(m%10==1&&m!="11"){i+="st"}else{if(m%10==2&&m!="12"){i+="nd"}else{if(m%10==3&&m!="13"){i+="rd"}else{i+="th"}}}break;default:i+=e}}}return i},navigate:function(c,e,b){switch(e){case"m":if($type(c.months)=="array"){var a=c.months.indexOf(c.month)+b;if(a<0||a==c.months.length){if(this.options.navigation==1){this.navigate(c,"y",b)}a=(a<0)?c.months.length-1:0}c.month=c.months[a]}else{var a=c.month+b;if(a<0||a==12){if(this.options.navigation==1){this.navigate(c,"y",b)}a=(a<0)?11:0}c.month=a}break;case"y":if($type(c.years)=="array"){var a=c.years.indexOf(c.year)+b;c.year=c.years[a]}else{c.year+=b}break}$extend(c,this.values(c));if($type(c.months)=="array"){var a=c.months.indexOf(c.month);if(a<0){c.month=c.months[0]}}this.display(c)},read:function(c){var a=[null,null,null];c.els.each(function(f){var g=this.unformat(f.value,f.format);g.each(function(h,i){if($type(h)=="number"){a[i]=h}})},this);if($type(a[0])=="number"){c.year=a[0]}if($type(a[1])=="number"){c.month=a[1]}var b=null;if(a.every(function(f){return $type(f)=="number"})){var e=new Date(a[0],a[1]+1,0).getDate();if(a[2]>e){a[2]=e}b=new Date(a[0],a[1],a[2])}return(c.val==b)?null:b},rebuild:function(a){a.els.each(function(c){if(c.getTag()=="select"&&c.format.test("^(d|j)$")){var b=this.value(a);if(!b){b=c.value.toInt()}c.empty();a.days.each(function(f){var e=new Element("option",{selected:(b==f),value:((c.format=="d"&&f<10)?"0"+f:f)}).appendText(f).injectInside(c)},this)}},this)},sort:function(b,a){return b-a},toggle:function(e){document.removeEvent("mousedown",this.fn);if(e.visible){e.visible=false;e.button.removeClass(this.classes.active);this.fx.start(1,0)}else{this.fn=function(g,h){var g=new Event(g);var i=g.target;var j=false;while(i!=document.body&&i.nodeType==1){if(i==this.calendar){j=true}this.calendars.each(function(k){if(k.button==i||k.els.contains(i)){j=true}});if(j){g.stop();return false}else{i=i.parentNode}}this.toggle(h)}.create({"arguments":e,bind:this,event:true});document.addEvent("mousedown",this.fn);this.calendars.each(function(g){if(g==e){g.visible=true;g.button.addClass(this.classes.active)}else{g.visible=false;g.button.removeClass(this.classes.active)}},this);var f=window.getSize().scrollSize;var b=e.button.getCoordinates();var a=b.right+this.options.tweak.x;var c=b.top+this.options.tweak.y;if(!this.calendar.coord){this.calendar.coord=this.calendar.getCoordinates()}if(a+this.calendar.coord.width>f.x){a-=(a+this.calendar.coord.width-f.x)}if(c+this.calendar.coord.height>f.y){c-=(c+this.calendar.coord.height-f.y)}this.calendar.setStyles({left:a+"px",top:c+"px"});if(window.ie6){this.iframe.setStyles({height:this.calendar.coord.height+"px",left:a+"px",top:c+"px",width:this.calendar.coord.width+"px"})}this.display(e);this.fx.start(0,1)}},unformat:function(c,h){h=h.escapeRegExp();var f={d:"([0-9]{2})",j:"([0-9]{1,2})",D:"("+this.options.days.map(function(k){return k.substr(0,3)}).join("|")+")",l:"("+this.options.days.join("|")+")",S:"(st|nd|rd|th)",F:"("+this.options.months.join("|")+")",m:"([0-9]{2})",M:"("+this.options.months.map(function(k){return k.substr(0,3)}).join("|")+")",n:"([0-9]{1,2})",Y:"([0-9]{4})",y:"([0-9]{2})"};var j=[];var i="";for(var b=0;b<h.length;b++){var g=h.charAt(b);if(f[g]){j.push(g);i+=f[g]}else{i+=g}}var a=c.match("^"+i+"$");var e=new Array(3);if(a){a=a.slice(1);j.each(function(k,l){l=a[l];switch(k){case"y":l="19"+l;case"Y":e[0]=l.toInt();break;case"F":l=l.substr(0,3);case"M":l=this.options.months.map(function(m){return m.substr(0,3)}).indexOf(l)+1;case"m":case"n":e[1]=l.toInt()-1;break;case"d":case"j":e[2]=l.toInt();break}},this)}return e},value:function(b){var a=null;if(b.val){if(b.year==b.val.getFullYear()&&b.month==b.val.getMonth()){a=b.val.getDate()}}return a},values:function(e){var g,a,b;e.els.each(function(j){if(j.getTag()=="select"){if(j.format.test("(y|Y)")){g=[];j.getChildren().each(function(k){var l=this.unformat(k.value,j.format);if(!g.contains(l[0])){g.push(l[0])}},this);g.sort(this.sort)}if(j.format.test("(F|m|M|n)")){a=[];j.getChildren().each(function(k){var l=this.unformat(k.value,j.format);if($type(l[0])!="number"||l[0]==e.year){if(!a.contains(l[1])){a.push(l[1])}}},this);a.sort(this.sort)}if(j.format.test("(d|j)")&&!j.format.test("^(d|j)$")){b=[];j.getChildren().each(function(k){var l=this.unformat(k.value,j.format);if(l[0]==e.year&&l[1]==e.month){if(!b.contains(l[2])){b.push(l[2])}}},this)}}},this);var c=1;var f=new Date(e.year,e.month+1,0).getDate();if(e.year==e.start.getFullYear()){if(a==null&&this.options.navigation==2){a=[];for(var h=0;h<12;h++){if(h>=e.start.getMonth()){a.push(h)}}}if(e.month==e.start.getMonth()){c=e.start.getDate()}}if(e.year==e.end.getFullYear()){if(a==null&&this.options.navigation==2){a=[];for(var h=0;h<12;h++){if(h<=e.end.getMonth()){a.push(h)}}}if(e.month==e.end.getMonth()){f=e.end.getDate()}}var i=this.blocked(e);if($type(b)=="array"){b=b.filter(function(j){if(j>=c&&j<=f&&!i.contains(j)){return j}})}else{b=[];for(var h=c;h<=f;h++){if(!i.contains(h)){b.push(h)}}}b.sort(this.sort);return{days:b,months:a,years:g}},write:function(a){this.rebuild(a);a.els.each(function(b){b.value=this.format(a.val,b.format)},this)}});Calendar.implement(new Events,new Options);